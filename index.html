<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>2026 丙午马年 · 粒子礼赞</title>
    <style>
        :root {
            --primary: #00f2ff;
            --secondary: #ff007a;
            --gold: #ffcc00;
            --text-color: #ffffff;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: #050510;
            color: var(--text-color);
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        #world {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
        }

        .universe-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: 
                radial-gradient(circle at 30% 20%, rgba(0, 242, 255, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 70% 80%, rgba(255, 204, 0, 0.15) 0%, transparent 50%),
                linear-gradient(to bottom, #050510, #101030);
            z-index: 0;
            pointer-events: none;
        }

        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(20px);
            transition: all 1s ease;
        }

        .card {
            width: 500px;
            padding: 50px;
            background: rgba(25, 25, 45, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 40px;
            text-align: center;
            box-shadow: 0 40px 100px rgba(0,0,0,0.6);
        }

        h1 {
            font-size: 3rem;
            margin-bottom: 20px;
            background: linear-gradient(to bottom, #fff, var(--gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 900;
        }

        .author-tag {
            color: rgba(255,255,255,0.6);
            margin-bottom: 40px;
            letter-spacing: 2px;
        }

        .select-wrapper {
            margin-bottom: 30px;
        }

        select {
            width: 100%;
            padding: 18px;
            background: #121225; 
            border: 1px solid var(--primary);
            border-radius: 15px;
            color: #fff;
            font-size: 1.1rem;
            cursor: pointer;
            outline: none;
            text-align: center;
            appearance: none;
        }

        .btn-start {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 50px;
            background: linear-gradient(90deg, var(--primary), var(--gold));
            color: #000;
            font-size: 1.3rem;
            font-weight: 900;
            cursor: pointer;
            transition: 0.3s;
        }

        #subtitle {
            position: fixed;
            bottom: 10%;
            width: 100%;
            text-align: center;
            z-index: 5;
            font-size: 1.8rem;
            color: #fff;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            font-weight: bold;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.6s ease;
            white-space: pre-wrap; /* 支持换行 */
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
</head>
<body>

    <div class="universe-bg"></div>
    <div id="world"></div>
    <div id="subtitle"></div>
    
    <div id="ui-layer">
        <div class="card">
            <h1>2026 粒子贺岁</h1>
            <p class="author-tag">西安高新逸翠园 · 八年级C6班 · 金在熙</p>
            <div class="select-wrapper">
                <select id="teacher-select">
                    <option value="" disabled selected>—— 请选择致敬老师 ——</option>
                    <option value="math">数学 - 王彬老师</option>
                    <option value="chinese">语文 - 赵爽老师</option>
                    <option value="english">英语 - 王曼老师</option>
                    <option value="politics">政治 - 徐小丹老师</option>
                </select>
            </div>
            <button class="btn-start" onclick="startShow()">开始祝福</button>
        </div>
    </div>

    <script>
        const BLESSINGS = {
            math: [
                {display: "王彬老师", sub: "祝王老师2026新年快乐"},
                {display: "师恩如山", sub: "感激您的悉心教导"},
                {display: "德高望重", sub: "岁月沉淀 智慧长存"},
                {display: "身体健康", sub: "龙马精神 岁岁平安"},
                {display: "万事胜意", sub: "生活处处有最优解"},
                {display: "福寿绵长", sub: "安康常伴 阖家欢乐"},
                {display: "桃李天下", sub: "春华秋实 硕果累累"},
                {display: "逻辑严密", sub: "解人生难题 游刃有余"},
                {display: "心怀坦荡", sub: "正直为本 坦诚待人"},
                {display: "一帆风顺", sub: "事业生活 步步高升"},
                {display: "智慧之源", sub: "感谢您点亮数学之光"},
                {display: "温文尔雅", sub: "君子之风 令人景仰"},
                {display: "平稳安泰", sub: "不惧风雨 闲庭信步"},
                {display: "满园芬芳", sub: "学生们的榜样与骄傲"},
                {display: "2026 丙午马年", sub: "愿您新的一年吉星高照"},
                {display: "常伴欢欣", sub: "笑口常开 忧虑全消"},
                {display: "思维永驻", sub: "保持好奇 保持热爱"},
                {display: "幸福无限", sub: "愿生活充满正能量"},
                {display: "致敬恩师", sub: "您辛苦了"},
                {display: "金在熙 敬呈", sub: "学生 金在熙 为您祝福"}
            ],
            chinese: [
                {display: "赵爽老师", sub: "祝赵老师新年大吉"},
                {display: "风华正茂", sub: "诗意青春 笔墨生辉"},
                {display: "文采斐然", sub: "字字珠玑 韵味深长"},
                {display: "如坐春风", sub: "听您的课是一种享受"},
                {display: "万事顺遂", sub: "心之所向 素履以往"},
                {display: "平安喜乐", sub: "愿您岁岁年年 欢愉常在"},
                {display: "大笔一挥", sub: "书写锦绣前程"},
                {display: "常怀热爱", sub: "眼有星辰 奔赴山海"},
                {display: "温婉如玉", sub: "知性优雅 沁人心脾"},
                {display: "步步生花", sub: "愿您的生活充满诗意"},
                {display: "卓尔不群", sub: "独特的灵魂 最美的光"},
                {display: "顺心顺意", sub: "没有烦恼 只有惊喜"},
                {display: "心向光明", sub: "每一天都充满希望"},
                {display: "青春不老", sub: "时光温柔 待您如初"},
                {display: "墨香留存", sub: "感谢您的文学启蒙"},
                {display: "自在舒心", sub: "忙里偷闲 享受生活"},
                {display: "元气满满", sub: "每天都有好心情"},
                {display: "梦想成真", sub: "期待更多美好发生"},
                {display: "老师辛苦了", sub: "最诚挚的感谢"},
                {display: "金在熙 敬呈", sub: "学生 金在熙 敬贺"}
            ],
            english: [
                {display: "Dear Ms. Wang", sub: "致 优雅的王曼老师"},
                {display: "Best Wishes", sub: "最诚挚的新年祝福\nHappy New Year"},
                {display: "Full of Wisdom", sub: "智慧博学 引领我们前行\nFull of wisdom"},
                {display: "Elegant Soul", sub: "知性优雅 气质非凡\nAn elegant soul"},
                {display: "Inspiration", sub: "您是我们的榜样\nYou are our inspiration"},
                {display: "Great Success", sub: "祝您事业辉煌\nWish you great success"},
                {display: "Pure Joy", sub: "愿您每一天都充满快乐\nMay you have pure joy"},
                {display: "Stay Young", sub: "时光荏苒 青春永驻\nStay young and beautiful"},
                {display: "Bright Future", sub: "前程似锦 光芒万丈\nA bright future ahead"},
                {display: "Health & Wealth", sub: "身体健康 财源广进\nHealth and wealth to you"},
                {display: "Kind Hearts", sub: "温柔以待 岁岁平安\nKind hearts get rewarded"},
                {display: "Peaceful Life", sub: "宁静致远 生活安泰\nLive a peaceful life"},
                {display: "Always Smiling", sub: "笑口常开 好运连连\nKeep on smiling always"},
                {display: "Magic Moments", sub: "生活处处有惊喜\nCreate magic moments"},
                {display: "Best Teacher", sub: "您是最好的老师\nYou are the best teacher"},
                {display: "High Spirits", sub: "精神抖擞 迎接挑战\nKeep your spirits high"},
                {display: "Wonderful 2026", sub: "精彩的2026年正在开启\nA wonderful year 2026"},
                {display: "Endless Love", sub: "被爱包围 温暖常在\nEndless love and warmth"},
                {display: "Heartfelt Thanks", sub: "由衷的感谢与敬意\nMy heartfelt thanks"},
                {display: "Yours, Jin Zaixi", sub: "学生 金在熙 敬上\nFrom your student"}
            ],
            politics: [
                {display: "徐小丹老师", sub: "祝徐老师新年快乐"},
                {display: "元气满满", sub: "青春无敌 活力四射"},
                {display: "正直灵魂", sub: "塑造品格 传递正能"},
                {display: "指路明灯", sub: "感谢您的思想引领"},
                {display: "永远年轻", sub: "心态不老 芳华长存"},
                {display: "心向暖阳", sub: "世界温柔 每一天都灿烂"},
                {display: "坚定不移", sub: "追逐梦想 无畏艰险"},
                {display: "通达睿智", sub: "洞察世事 明辨是非"},
                {display: "生活美满", sub: "阖家团圆 幸福安康"},
                {display: "事事称心", sub: "心之所愿 皆能实现"},
                {display: "魅力十足", sub: "自信最美 闪耀全场"},
                {display: "笑逐颜开", sub: "烦恼走开 快乐留下来"},
                {display: "步步稳健", sub: "稳打稳扎 步步高升"},
                {display: "大吉大利", sub: "2026 好运加倍"},
                {display: "格局宏大", sub: "胸怀天下 展望未来"},
                {display: "惬意从容", sub: "生活优雅 节奏自如"},
                {display: "平安喜乐", sub: "简单的生活 最真的福"},
                {display: "满怀希望", sub: "期待新的一年 更多精彩"},
                {display: "老师您辛苦了", sub: "向您致以崇高敬意"},
                {display: "金在熙 敬呈", sub: "学生 金在熙 贺岁"}
            ]
        };

        let scene, camera, renderer, particles;
        const PARTICLE_COUNT = 85000; // 粒子数继续优化
        const posArr = new Float32Array(PARTICLE_COUNT * 3);
        const targetArr = new Float32Array(PARTICLE_COUNT * 3);
        const colorArr = new Float32Array(PARTICLE_COUNT * 3);

        let textIndex = 0;
        let isShowStarted = false;

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 10000);
            camera.position.z = 1200;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.getElementById('world').appendChild(renderer.domElement);

            const sprite = createGlowTexture();
            const geometry = new THREE.BufferGeometry();
            
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const r = 2000 * Math.random();
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.random() * Math.PI;
                posArr[i*3] = r * Math.sin(phi) * Math.cos(theta);
                posArr[i*3+1] = r * Math.sin(phi) * Math.sin(theta);
                posArr[i*3+2] = r * Math.cos(phi);
                targetArr[i*3] = posArr[i*3];
                targetArr[i*3+1] = posArr[i*3+1];
                targetArr[i*3+2] = posArr[i*3+2];
                colorArr[i*3] = 0.5; colorArr[i*3+1] = 0.8; colorArr[i*3+2] = 1.0;
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(posArr, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colorArr, 3));

            const material = new THREE.PointsMaterial({
                size: 9,
                map: sprite,
                vertexColors: true,
                blending: THREE.AdditiveBlending,
                transparent: true,
                depthTest: false
            });

            particles = new THREE.Points(geometry, material);
            scene.add(particles);

            window.addEventListener('resize', onResize);
            animate();
        }

        function createGlowTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 64; canvas.height = 64;
            const ctx = canvas.getContext('2d');
            const grad = ctx.createRadialGradient(32,32,0,32,32,32);
            grad.addColorStop(0, 'white');
            grad.addColorStop(0.2, 'rgba(0,242,255,0.7)');
            grad.addColorStop(1, 'black');
            ctx.fillStyle = grad; ctx.fillRect(0,0,64,64);
            const tex = new THREE.Texture(canvas);
            tex.needsUpdate = true; return tex;
        }

        // 核心改动：支持换行和更精美的边缘
        function calculateTextCoords(text) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 2400; canvas.height = 1200;
            
            const isChinese = /[\u4e00-\u9fa5]/.test(text);
            const fSize = isChinese ? 240 : 180;
            ctx.font = `900 ${fSize}px "PingFang SC", "Microsoft YaHei", Arial`;
            ctx.fillStyle = "white";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";

            // 分行处理（按单词或字数）
            const words = text.split(" ");
            if (words.length > 2 && !isChinese) {
                const mid = Math.ceil(words.length / 2);
                const line1 = words.slice(0, mid).join(" ");
                const line2 = words.slice(mid).join(" ");
                ctx.fillText(line1, 1200, 450);
                ctx.fillText(line2, 1200, 750);
            } else if (text.length > 6 && isChinese) {
                const line1 = text.substring(0, 4);
                const line2 = text.substring(4);
                ctx.fillText(line1, 1200, 450);
                ctx.fillText(line2, 1200, 750);
            } else {
                ctx.fillText(text, 1200, 600);
            }

            const data = ctx.getImageData(0,0,2400,1200).data;
            const coords = [];
            const step = isChinese ? 3 : 4;

            for(let y=0; y<1200; y+=step){
                for(let x=0; x<2400; x+=step){
                    if(data[(y*2400 + x)*4 + 3] > 100){
                        coords.push({x: (x-1200)*1.4, y: -(y-600)*1.4});
                    }
                }
            }
            return coords;
        }

        async function nextSlide() {
            const teacher = document.getElementById('teacher-select').value;
            const list = BLESSINGS[teacher];
            if(textIndex >= list.length) {
                isShowStarted = false;
                textIndex = 0;
                document.getElementById('ui-layer').style.opacity = 1;
                document.getElementById('ui-layer').style.pointerEvents = "auto";
                document.getElementById('subtitle').style.opacity = 0;
                return;
            }

            const item = list[textIndex];
            textIndex++;

            const sub = document.getElementById('subtitle');
            sub.innerHTML = item.sub;
            sub.style.opacity = 1;

            // 扩散动画
            for(let i=0; i<PARTICLE_COUNT; i++){
                targetArr[i*3] *= 1.5;
                targetArr[i*3+1] *= 1.5;
                targetArr[i*3+2] += 2000;
            }
            
            await new Promise(r => setTimeout(r, 800)); 

            const coords = calculateTextCoords(item.display);
            coords.sort(() => Math.random() - 0.5);

            for (let i = 0; i < PARTICLE_COUNT; i++) {
                if (i < coords.length) {
                    targetArr[i*3] = coords[i].x;
                    targetArr[i*3+1] = coords[i].y;
                    targetArr[i*3+2] = 0;
                    colorArr[i*3] = 0.2; colorArr[i*3+1] = 0.95; colorArr[i*3+2] = 1.0;
                } else {
                    const r = 2500 + Math.random()*1500;
                    const a = Math.random()*Math.PI*2;
                    targetArr[i*3] = Math.cos(a)*r;
                    targetArr[i*3+1] = Math.sin(a)*r;
                    targetArr[i*3+2] = -2000 - Math.random()*2000;
                    colorArr[i*3] = 0.8; colorArr[i*3+1] = 0.5; colorArr[i*3+2] = 0.1;
                }
            }
            particles.geometry.attributes.color.needsUpdate = true;

            setTimeout(nextSlide, 3800); 
        }

        function startShow() {
            if(!document.getElementById('teacher-select').value) return;
            isShowStarted = true;
            document.getElementById('ui-layer').style.opacity = 0;
            document.getElementById('ui-layer').style.pointerEvents = "none";
            nextSlide();
        }

        function animate() {
            requestAnimationFrame(animate);
            TWEEN.update();
            const time = Date.now() * 0.001;
            const pos = particles.geometry.attributes.position;
            
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const ix = i*3, iy = i*3+1, iz = i*3+2;
                const lerp = isShowStarted ? 0.08 : 0.02;
                pos.array[ix] += (targetArr[ix] - pos.array[ix]) * lerp;
                pos.array[iy] += (targetArr[iy] - pos.array[iy]) * lerp;
                pos.array[iz] += (targetArr[iz] - pos.array[iz]) * lerp;
                
                if(isShowStarted) {
                    pos.array[ix] += Math.sin(time*1.5 + i)*0.4;
                    pos.array[iy] += Math.cos(time*1.5 + i)*0.4;
                }
            }
            pos.needsUpdate = true;
            camera.position.x = Math.sin(time*0.4)*30;
            camera.lookAt(0,0,0);
            renderer.render(scene, camera);
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        init();
    </script>
</body>
</html>